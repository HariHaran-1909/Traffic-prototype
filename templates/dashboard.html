<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Traffic Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
    body { background:#f7f9fc; color:#333; }

    /* Top Navbar */
    .navbar {
      display:flex; justify-content:space-between; align-items:center;
      padding:15px 30px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05);
      position:sticky; top:0; z-index:10;
    }
    .navbar-left { display:flex; align-items:center; gap:10px; }
    .navbar-left h1 { font-size:20px; font-weight:700; color:#2563eb; }
    .navbar nav a {
      margin:0 10px; text-decoration:none; color:#555; font-weight:500;
    }
    .navbar nav a:hover { color:#2563eb; }
    .navbar-right button {
      border:none; background:#f3f4f6; padding:8px 14px; border-radius:8px;
      cursor:pointer; font-weight:500;
    }

    /* Alert */
    .alert {
      margin:20px auto; padding:12px 18px; border-radius:8px;
      max-width:1200px; font-size:15px; font-weight:500;
    }
    .alerthigh { background:#fff3cd; border:1px solid #ffeeba; color:#856404; }
    .alertlow { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
    .alertmedium { background:#fff8e1; border:1px solid #ffecb5; color:#856404; }

    /* Search Section */
    .search-bar {
      max-width:1200px; margin:10px auto; background:#fff; padding:15px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05); display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .search-bar input, .search-bar select {
      padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;
    }
    .search-bar button {
      padding:10px 20px; background:#2563eb; color:#fff; border:none; border-radius:8px; cursor:pointer;
    }
    .quick-filters { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .quick-filters button {
      background:#f1f5f9; border:none; border-radius:20px; padding:6px 14px; font-size:13px; cursor:pointer;color: #020a1b;
    }

    /* Stat Cards */
    .stats { max-width:1200px; margin:20px auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
    .card {
      background:#fff; padding:20px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05); text-align:left;
    }
    .card h3 { font-size:14px; color:#666; margin-bottom:8px; }
    .card p { font-size:24px; font-weight:700; }
    .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:600; }
    .badge.green { background:#d4edda; color:#155724; }
    .badge.yellow { background:#fff3cd; color:#856404; }
    .badge.red { background:#f8d7da; color:#721c24; }

    /* Chart Section */
    .chart-container {
      max-width:1200px; margin:20px auto; background:#fff; padding:20px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }

    /* Actions + Status */
    .actions, .status {
      max-width:1200px; margin:20px auto; background:#fff; padding:20px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .actions button {
      padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; margin-right:10px;
    }
    .report-btn { background:#fff3cd; color:#856404; }
    .override-btn { background:#2563eb; color:#fff; }

    .status ul { list-style:none; margin-top:10px; }
    .status li { margin:6px 0; font-size:14px; }
    .status li span { font-weight:600; margin-left:6px; color:#2563eb; }
  </style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <div class="navbar-left">
    <h1>ðŸ“Š Smart Traffic Monitor</h1>
    <small>{{ role|capitalize }}</small>
  </div>
  <nav>
    <a href="/">Dashboard</a>
    {% if role == 'operator' %}<a href="#" onclick="showReports()">Reports ({{ reports_count }})</a>{% endif %}
    <a href="#" onclick="document.getElementById('aboutModal').style.display='block'">About</a>
  </nav>
  <div class="navbar-right">
    <button onclick="window.location.href='/logout'">Logout</button>
  </div>
</div>

<!-- Alerts -->
<div class="alert {{ alert_class }}">
  {{ alert_message }} &nbsp; | &nbsp; Updated: {{ time_labels[-1] if time_labels else "N/A" }}
</div>

<!-- Search -->
<div class="search-bar">
  <input type="text" id="searchBar" placeholder="Search by location, time, or incident..." onkeyup="searchTraffic()" />
  
  <select id="timeFilter" onchange="searchTraffic()">
    <option value="all">All Time</option>
    <option value="today">Today</option>
    <option value="week">This Week</option>
    <option value="month">This Month</option>
  </select>
  
  <select id="statusFilter" onchange="searchTraffic()">
    <option value="all">All Status</option>
    <option value="low">Low</option>
    <option value="mid">Medium</option>
    <option value="high">High</option>
  </select>
  
  <button onclick="searchTraffic()">Search</button>
  
  <div class="quick-filters">
    <button onclick="showActiveIncidents()">Active Incidents</button>
    <button onclick="showPeakHours()">Peak Hours</button>
    <button onclick="showSignalOverrides()">Signal Overrides</button>
    <button onclick="showRecentReports()">Recent Reports</button>
  </div>
</div>


</div>

<!-- Stats -->
<div class="stats">
  <div class="card">
    <h3>Live Vehicle Count</h3>
    <p>{{ vehicle_count }}</p>
    <small>vehicles detected</small>
  </div>
  <div class="card">
    <h3>Average Speed</h3>
    <p>{{ avg_speed }} km/h</p>
    <small>across all lanes</small>
  </div>
  <div class="card">
    <h3>Congestion Level</h3>
    <span class="badge {% if congestion_level=='high' %}red{% elif congestion_level=='medium' %}yellow{% else %}green{% endif %}">
      {{ congestion_level|upper }}
    </span>
    <br><small>traffic density status</small>
  </div>
  <div class="card">
    <h3>Signal Override</h3>
    <span class="badge {% if signal_override %}yellow{% else %}green{% endif %}">
      {{ "ACTIVE" if signal_override else "NORMAL" }}
    </span>
    <br><small>manual control status</small>
  </div>
</div>

<!-- Chart -->
<div class="chart-container">
  <h3>Vehicle Count Trends</h3>
  <canvas id="vehicleChart" height="120"></canvas>
</div>

<!-- Actions -->
<div class="actions">
  <h3>Quick Actions</h3>
  <button class="report-btn" onclick="reportCongestion()">âš  Report Congestion</button>
  <button class="override-btn" onclick="toggleSignalOverride()">âš™ Signal Override</button>
</div>

<!-- Status -->
<div class="status">
  <h3>System Status</h3>
  <ul>
    <li>AI Monitoring: <span>Active</span></li>
    <li>Camera Network: <span>98% Online</span></li>
    <li>Signal System: <span>{{ "Manual" if signal_override else "Auto" }}</span></li>
    <li>Data Processing: <span>Real-time</span></li>
  </ul>
</div>

<!-- About Modal -->
<div id="aboutModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4)">
  <div style="background:#fff;padding:30px;border-radius:12px;max-width:500px;margin:10% auto;position:relative;color:#333;">
    <button onclick="document.getElementById('aboutModal').style.display='none'" 
      style="position:absolute;top:15px;right:20px;border:none;background:none;font-size:24px;cursor:pointer">&times;</button>
    <h2>About Smart Traffic Monitor</h2>
    <p>AI-powered traffic monitoring system with real-time vehicle detection, congestion prediction, and adaptive signal control.</p>
  </div>
</div>

<script>
let timeLabels = {{ time_labels | tojson | safe }};
let vehicleData = {{ historical_vehicle_counts | tojson | safe }};

const ctxVehicle = document.getElementById('vehicleChart').getContext('2d');
let chart = new Chart(ctxVehicle, {
    type: 'line',
    data: { labels: timeLabels, datasets: [{ label: 'Vehicle Count', data: vehicleData, borderColor: '#2563eb', fill:true, backgroundColor:'rgba(37,99,235,0.1)', tension:0.3 }] },
    options: { responsive:true, plugins:{ legend:{labels:{color:'#333'}} } }
});

function searchTraffic() {
  const query = document.getElementById("searchBar").value;
  const timeFilter = document.getElementById("timeFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;

  fetch(`/search_traffic?q=${query}&time=${timeFilter}&status=${statusFilter}`)
    .then(res => res.json())
    .then(data => {
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.data;
      chart.update();
    });
}

function reportCongestion() {
  fetch('/report_congestion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Dashboard'})})
  .then(res=>res.json()).then(data=>alert(data.message));
}
function toggleSignalOverride() {
  fetch('/signal_override',{method:'POST'}).then(res=>res.json()).then(data=>{alert(data.message);setTimeout(()=>window.location.reload(),1000);});
}
function showReports() {
  fetch('/get_reports').then(res=>res.json()).then(data=>{let text=data.reports.map(r=>`${r.timestamp}: ${r.message}`).join('\n');alert(text||'No reports yet');});
}

function showActiveIncidents() {
  fetch('/active_incidents').then(res=>res.json()).then(data=>{
    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.data;
    chart.update();
  });
}

function showPeakHours() {
  fetch('/peak_hours').then(res=>res.json()).then(data=>{
    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.data;
    chart.update();
  });
}

function showSignalOverrides() {
  fetch('/signal_override_periods').then(res=>res.json()).then(data=>{
    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.data;
    chart.update();
  });
}

function showRecentReports() {
  fetch('/recent_reports').then(res=>res.json()).then(data=>{
    let text = data.reports.map(r => `${r.timestamp}: ${r.message} (${r.location})`).join('\n');
    alert(text || 'No recent reports.');
  });
}

</script>

</body>
</html>












